<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Wrangled Ramblings: Automated Cryogen Gh Pages Deployments</title>
    <link rel="canonical" href="https://wmatson.github.io/wrangled-ramblings/posts-output/automated-cryogen-gh-pages-deployments/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700" rel="stylesheet"
          type="text/css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/atom-one-dark.min.css">
    <link href="/wrangled-ramblings/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/wrangled-ramblings/">Wrangled Ramblings</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/wrangled-ramblings/">Home</a></li>
                <li
                ><a href="/wrangled-ramblings/archives/">Archives</a></li>
                
                <li
                >
                <a href="/wrangled-ramblings/pages-output/about/">About</a>
                </li>
                
                <li><a href="/wrangled-ramblings/feed.xml">RSS</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li class="dropdown-header">Links</li>
                        <li><a href="http://cryogenweb.org/docs/home.html">Cryogen Docs</a></li>
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a href="/wrangled-ramblings/posts-output/why-gurps/">Why GURPS</a></li>
                        
                        <li><a href="/wrangled-ramblings/posts-output/automated-cryogen-gh-pages-deployments/">Automated Cryogen Gh Pages Deployments</a></li>
                        
                        <li><a href="/wrangled-ramblings/posts-output/my-first-cryogen-blog/">My First Cryogen Blog</a></li>
                        
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a href="/wrangled-ramblings/tags-output/GURPS/">GURPS</a></li>
                        
                        <li><a href="/wrangled-ramblings/tags-output/tabletop/">tabletop</a></li>
                        
                        <li><a href="/wrangled-ramblings/tags-output/non-dev/">non-dev</a></li>
                        
                        <li><a href="/wrangled-ramblings/tags-output/cyrogen/">cyrogen</a></li>
                        
                        <li><a href="/wrangled-ramblings/tags-output/dev/">dev</a></li>
                        
                        <li><a href="/wrangled-ramblings/tags-output/cryogen/">cryogen</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">June 8, 2018</div>
        
    </div>
    <h2>Automated Cryogen Gh Pages Deployments</h2>
</div>
<div>
    
    <p>While I was fiddling with getting disqus working, I found that the deployment process to github pages was rather tedious. So I decided to automate it.</p><p>A few googles later, I decided to use <a href='https://circleci.com/'>CircleCI</a> to manage the builds and automatically deploy. Several blog posts on how to do this using CircleCI 1.0 existed already, but when I went to follow one, I quickly realized that 1.0 was deprecated and on its way out of support.</p><p>Luckily, <a href='https://blog.frederikring.com/articles/deploying-github-pages-circle-ci/'>someone already did the work</a> to figure out the process. Unfortunately, their method had a couple issues that I'll explain later. Over the course of experimentation, I found two other resources that proved important: The CircleCI documentation about checkout keys (found <code>https://circleci.com/gh/&lt;your-username&gt;/&lt;your-project&gt;/edit#checkout</code>, at the time of this writing,  I couldn't find a good link that wasn't project-specific), and <a href='https://github.com/DevProgress/onboarding/wiki/Using-Circle-CI-with-Github-Pages-for-Continuous-Delivery'>the github documentation</a> on using CircleCI (specifically <code>Creating a machine user</code> towards the bottom third of the page).</p><hr/><p>While fiddling with the process, I made sure to set my deploy target to a branch other than <code>gh-pages</code> (I used <code>gh-pages-test</code> which bares no significance to github) so as not to disturb the currently-working blog site, I'd recommend you do the same.</p><hr/><h2 id="some&#95;caveats">Some Caveats</h2><p>The <a href='https://blog.frederikring.com/articles/deploying-github-pages-circle-ci/'>blog I followed along</a> had a couple issues.</p><h4 id="node&#95;instead&#95;of&#95;clojure">Node instead of Clojure</h4><p><a href='http://cryogenweb.org/'>Cryogen</a> uses Clojure (specifically <a href='https://leiningen.org/'>Leiningen</a> to build the blog site. As a result, I needed to merge the config.yml in <a href='https://blog.frederikring.com/articles/deploying-github-pages-circle-ci/'>the blog</a> with <a href='https://circleci.com/docs/2.0/language-clojure/#sample-configuration'>CircleCI's Clojure example</a>  (I used the one generated when initially setting up a project, which I couldn't quickly find a link to it's the same before <code>run: lein do ...</code>).</p><p>Additionally, the deploy process ran <code>npm run build</code> which won't work with a Clojure project/CircleCI image.</p><pre><code>...

git checkout $TARGET&#95;BRANCH || git checkout --orphan $TARGET&#95;BRANCH
git rm -rf .
cd ..

npm run build

cp -a build/. out/.

mkdir -p out/.circleci &amp;&amp; cp -a .circleci/. out/.circleci/.
cd out

...
</code></pre><p>I removed the <code>npm run build</code> line entirely, opting to build before the deploy process. Instead, I opted to build using <code>lein run</code> (This runs the project's main method, Cryogen projects' main builds the blog). This replaced <code>lein do test, uberjar</code> in the configuration.</p><p>You can find my final/current working config <a href='https://github.com/wmatson/wrangled-ramblings/blob/master/.circleci/config.yml'>here</a>.</p><h4 id="environment&#95;misconfiguration">Environment Misconfiguration</h4><p>First, in their <code>config.yml</code> snippet, there was some configuration in the <code>environment</code> tag that I had to change for reasons beyond me.</p><pre><code>    environment:
      - SOURCE&#95;BRANCH: master
      - TARGET&#95;BRANCH: gh-pages
</code></pre><p>should be</p><pre><code>    environment:
      SOURCE&#95;BRANCH: master
      TARGET&#95;BRANCH: gh-pages
</code></pre><p>notice the now-missing hyphens.</p><hr/><p>Overall, this was an interesting experience, I had enough fun/focus that I lost track of time and went to bed hungry. Here's my final CircleCI <code>config.yml</code> at the time of this writing:</p><pre><code>version: 2
jobs:
  build:
    branches:
      ignore:
        - gh-pages
    docker:
      # specify the version you desire here
      - image: circleci/clojure:lein-2.7.1

    working&#95;directory: &#126;/repo

    environment:
      LEIN&#95;ROOT: &quot;true&quot;
      # Customize the JVM maximum heap limit
      JVM&#95;OPTS: -Xmx3200m
      SOURCE&#95;BRANCH: master
      TARGET&#95;BRANCH: gh-pages

    steps:
      - checkout

      # Download and cache dependencies
      - restore&#95;cache:
          keys:
          - v1-dependencies-{{ checksum &quot;project.clj&quot; }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-

      - run: lein deps

      - save&#95;cache:
          paths:
            - &#126;/.m2
          key: v1-dependencies-{{ checksum &quot;project.clj&quot; }}

      - run: lein run

      - deploy:
          name: Deploy
          command: |
            if &#91; $CIRCLE&#95;BRANCH == $SOURCE&#95;BRANCH &#93;; then
              git config --global user.email $GH&#95;EMAIL
              git config --global user.name $GH&#95;NAME

              git clone $CIRCLE&#95;REPOSITORY&#95;URL out

              cd out
              git checkout $TARGET&#95;BRANCH || git checkout --orphan $TARGET&#95;BRANCH
              git rm -rf .
              cd ..

              cp -a resources/public/wrangled-ramblings/. out/.

              mkdir -p out/.circleci &amp;&amp; cp -a .circleci/. out/.circleci/.
              cd out

              git add -A
              git commit -m &quot;Automated deployment to GitHub Pages: ${CIRCLE&#95;SHA1}&quot; --allow-empty

              git push origin $TARGET&#95;BRANCH
            fi
</code></pre>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/wrangled-ramblings/tags-output/cyrogen/">cyrogen</a>
    
    <a href="/wrangled-ramblings/tags-output/dev/">dev</a>
    
</div>


    <div id="prev-next">
        
        <a href="/wrangled-ramblings/posts-output/why-gurps/">&laquo; Why GURPS</a>
        
        
        <a class="right" href="/wrangled-ramblings/posts-output/my-first-cryogen-blog/">My First Cryogen Blog &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://wmatson.github.io/wrangled-ramblings/posts-output/automated-cryogen-gh-pages-deployments/";
            this.page.identifier = "Automated Cryogen Gh Pages Deployments";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//wrangled-ramblings.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2018 Wesley Matson
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/wrangled-ramblings/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
